<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>I-C-your-I-D | DevSecOps Patrol</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="split-container" id="split-container">
    <main class="panel">
      <section class="header">
        <div>
          <div class="badge">I-C-your-I-D Patrol</div>
          <h1>I see your ID.<br>And your insecure dependencies.</h1>
          <p class="subtitle">First Pipeline Challenge - A mildly paranoid DevSecOps dashboard with severe trust issues.</p>
        </div>
      </section>

      <section class="grid">
        <article class="card">
          <h2>CI</h2>
          <p>Builds run faster than rumors in standup. Tests execute before coffee is cold.</p>
          <span class="state ok">Pipeline Green-ish</span>
        </article>

        <article class="card">
          <h2>CD</h2>
          <p>Deploys on merge like clockwork. If it breaks in prod, we call it "monitoring data".</p>
          <span class="state warn">Webhook Armed</span>
        </article>

        <article class="card">
          <h2>DevSecOps</h2>
          <p>Trivy scans every image. Vulnerabilities get named and shamed in broad daylight.</p>
          <span class="state danger">Trust But Verify</span>
        </article>

        <article class="card">
          <h2>ID Checkpoint</h2>
          <p>"I-C-your-I-D" means no anonymous commits, no mystery containers, no mercy.</p>
          <span class="state ok">Identity Confirmed</span>
        </article>
      </section>

      <div class="terminal">
        <div class="terminal-bar">
          <span class="terminal-dot red"></span>
          <span class="terminal-dot yellow"></span>
          <span class="terminal-dot green"></span>
          <span class="terminal-label">terminal</span>
        </div>
        <div class="terminal-body">
          <div class="terminal-output" id="terminal-output"></div>
          <div class="terminal-input-row">
            <span class="terminal-prompt">$</span>
            <input type="text" id="terminal-input" class="terminal-input"
              placeholder="try /secret, /health, /coffee ..." autocomplete="off" spellcheck="false">
          </div>
        </div>
      </div>

      <footer class="footer">
        <div>"Move fast and patch things."</div>
        <div class="links" id="endpoint-links">
          <span>Loading endpoints...</span>
        </div>
        <div class="metrics-bar" id="metrics-bar"></div>
      </footer>
    </main>

    <aside class="side-panel" id="side-panel">
      <div class="side-header">
        <h2 id="side-title">Panel</h2>
        <a href="#" id="side-close" class="side-close-btn">&times;</a>
      </div>
      <div class="side-body" id="side-body"></div>
    </aside>
  </div>

  <script>
    // â”€â”€ Endpoint links â”€â”€
    async function loadEndpoints() {
      try {
        const res = await fetch('/api/endpoints');
        const endpoints = await res.json();
        const container = document.getElementById('endpoint-links');
        const links = endpoints
          .filter(e => e.method === 'GET' && e.path !== '/' && !e.path.startsWith('/api/')
            && !['/secret', '/konami', '/coffee'].includes(e.path))
          .map(e => `<a href="#" onclick="openEndpoint('${e.path}', event)">${e.path}</a>`)
          .join('');
        container.innerHTML = links +
          '<a href="#" onclick="openDocs(event)">ðŸ“– Docs</a>';
      } catch {
        document.getElementById('endpoint-links').innerHTML = '<span>Could not load endpoints</span>';
      }
    }

    // â”€â”€ Live metrics bar â”€â”€
    async function loadMetrics() {
      try {
        const res = await fetch('/metrics');
        const m = await res.json();
        document.getElementById('metrics-bar').innerHTML =
          `Requests: ${m.totalRequests} Â· Avg: ${m.responseTime.avg} Â· Uptime: ${m.uptime}`;
      } catch {
        document.getElementById('metrics-bar').textContent = '';
      }
    }

    // â”€â”€ Side panel helpers â”€â”€
    function openPanel(title) {
      document.getElementById('side-title').textContent = title;
      document.getElementById('split-container').classList.add('panel-open');
    }

    function closePanel() {
      document.getElementById('split-container').classList.remove('panel-open');
    }

    document.getElementById('side-close').addEventListener('click', (e) => {
      e.preventDefault();
      closePanel();
    });

    // â”€â”€ Render a value as clean HTML (recursive, no brackets) â”€â”€
    function renderValue(val, depth) {
      depth = depth || 0;
      if (val === null || val === undefined) {
        return '<span class="ev-null">null</span>';
      }
      if (Array.isArray(val)) {
        // Render array items as a list
        return '<div class="ev-list">' +
          val.map(item => {
            if (typeof item === 'object' && item !== null) {
              return '<div class="ev-list-item">' + renderObject(item, depth + 1) + '</div>';
            }
            return '<div class="ev-list-item">' + renderScalar(item) + '</div>';
          }).join('') +
          '</div>';
      }
      if (typeof val === 'object') {
        return renderObject(val, depth);
      }
      return renderScalar(val);
    }

    function renderScalar(val) {
      if (typeof val === 'boolean') {
        return val
          ? '<span class="ev-bool ev-true">true</span>'
          : '<span class="ev-bool ev-false">false</span>';
      }
      if (typeof val === 'number') {
        return '<span class="ev-num">' + val + '</span>';
      }
      // String
      const s = String(val);
      // Detect "123ms" / "45s" style metric values
      if (/^\d+m?s$/.test(s)) {
        return '<span class="ev-metric">' + esc(s) + '</span>';
      }
      // Detect ISO timestamps
      if (/^\d{4}-\d{2}-\d{2}T/.test(s)) {
        const d = new Date(s);
        return '<span class="ev-time">' + d.toLocaleString() + '</span>';
      }
      return '<span class="ev-str">' + esc(s) + '</span>';
    }

    function renderObject(obj, depth) {
      depth = depth || 0;
      const cls = depth === 0 ? 'ev-group ev-root' : 'ev-group ev-nested';
      return '<div class="' + cls + '">' +
        Object.entries(obj).map(([key, val]) => {
          const isNested = typeof val === 'object' && val !== null;
          if (isNested) {
            return '<div class="ev-section">' +
              '<div class="ev-section-title">' + esc(key) + '</div>' +
              renderValue(val, depth + 1) +
              '</div>';
          }
          return '<div class="ev-row">' +
            '<span class="ev-key">' + esc(key) + '</span>' +
            '<span class="ev-val">' + renderValue(val, depth + 1) + '</span>' +
            '</div>';
        }).join('') +
        '</div>';
    }

    function esc(s) {
      const el = document.createElement('span');
      el.textContent = s;
      return el.innerHTML;
    }

    // â”€â”€ Open endpoint in side panel â”€â”€
    let activeEndpoint = null;
    let refreshInterval = null;

    async function openEndpoint(path, e) {
      e.preventDefault();
      openPanel(path);
      activeEndpoint = path;
      document.getElementById('side-body').className = 'side-body side-body--endpoint';
      await fetchAndRenderEndpoint(path);

      // Auto-refresh for live endpoints
      clearInterval(refreshInterval);
      if (path === '/metrics' || path === '/health') {
        refreshInterval = setInterval(() => {
          if (activeEndpoint === path) fetchAndRenderEndpoint(path);
        }, 3000);
      }
    }

    async function fetchAndRenderEndpoint(path) {
      try {
        const res = await fetch(path);
        const data = await res.json();
        document.getElementById('side-body').innerHTML = renderValue(data, 0);
      } catch {
        document.getElementById('side-body').innerHTML =
          '<p class="muted">Could not load ' + path + '</p>';
      }
    }

    // â”€â”€ Open docs (README) in side panel â”€â”€
    let docsHtml = null;

    async function openDocs(e) {
      e.preventDefault();
      activeEndpoint = null;
      clearInterval(refreshInterval);
      openPanel('Documentation');
      document.getElementById('side-body').className = 'side-body side-body--docs';

      if (docsHtml) {
        document.getElementById('side-body').innerHTML = docsHtml;
        return;
      }

      document.getElementById('side-body').innerHTML = '<p class="muted">Loading README...</p>';
      try {
        const res = await fetch(
          'https://api.github.com/repos/krto-chas/can-i-c-your-i-d/readme',
          { headers: { Accept: 'application/vnd.github.html+json' } }
        );
        if (!res.ok) throw new Error('Failed to fetch');
        docsHtml = await res.text();
        document.getElementById('side-body').innerHTML = docsHtml;
      } catch {
        document.getElementById('side-body').innerHTML =
          '<p class="muted">Could not load README. <a href="https://github.com/krto-chas/can-i-c-your-i-d/blob/main/README.md" target="_blank">Open on GitHub</a></p>';
      }
    }

    // â”€â”€ Terminal â”€â”€
    const termInput = document.getElementById('terminal-input');
    const termOutput = document.getElementById('terminal-output');

    const localCommands = {
      help: () => 'Available commands: /health, /status, /metrics, /version, /ready, /live, help, clear\nThere might also be some hidden ones...',
      clear: () => { termOutput.innerHTML = ''; return null; },
    };

    termInput.addEventListener('keydown', async (e) => {
      if (e.key !== 'Enter') return;
      const raw = termInput.value.trim();
      if (!raw) return;
      termInput.value = '';

      // Echo command
      appendLine('$ ' + raw, 'term-cmd');

      // Local commands
      if (localCommands[raw]) {
        const result = localCommands[raw]();
        if (result) appendLine(result, 'term-info');
        return;
      }

      // Ensure path starts with /
      const endpoint = raw.startsWith('/') ? raw : '/' + raw;

      // Only allow local paths (no protocol/domain)
      if (endpoint.includes('://') || endpoint.includes('..')) {
        appendLine('Error: only local endpoints allowed', 'term-err');
        return;
      }

      try {
        const res = await fetch(endpoint);
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { data = null; }

        if (data) {
          // Also open in side panel
          openPanel(endpoint);
          activeEndpoint = endpoint;
          document.getElementById('side-body').className = 'side-body side-body--endpoint';
          document.getElementById('side-body').innerHTML = renderValue(data, 0);

          // Show compact summary in terminal
          appendLine(res.status + ' OK', 'term-ok');
          const preview = JSON.stringify(data, null, 2).split('\n').slice(0, 6).join('\n');
          appendLine(preview + (JSON.stringify(data, null, 2).split('\n').length > 6 ? '\n  ...' : ''), 'term-json');
        } else {
          appendLine(res.status + ' ' + text.substring(0, 120), 'term-info');
        }
      } catch (err) {
        appendLine('Error: ' + err.message, 'term-err');
      }

      // Auto-scroll
      termOutput.scrollTop = termOutput.scrollHeight;
    });

    function appendLine(text, cls) {
      const line = document.createElement('div');
      line.className = 'term-line ' + (cls || '');
      line.textContent = text;
      termOutput.appendChild(line);
      termOutput.scrollTop = termOutput.scrollHeight;
    }

    // Focus terminal on click
    document.querySelector('.terminal-body').addEventListener('click', () => {
      termInput.focus();
    });

    // â”€â”€ Init â”€â”€
    loadEndpoints();
    loadMetrics();
    setInterval(loadMetrics, 5000);
  </script>
</body>
</html>
